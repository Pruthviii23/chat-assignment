<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart University Enquiry Chatbot</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        /* Custom styles for a better chat aesthetic */
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@100..900&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .chat-container {
            max-height: 70vh;
            overflow-y: auto;
            scroll-behavior: smooth;
        }
        /* Style for the user message bubble */
        .user-message {
            background-color: #3b82f6; /* Blue 500 */
            color: white;
            border-radius: 1.5rem 1.5rem 0.5rem 1.5rem; /* Rounded corners, pointed bottom-right */
            max-width: 80%;
            word-wrap: break-word;
        }
        /* Style for the bot message bubble */
        .bot-message {
            background-color: #ffffff; /* White */
            color: #1f2937; /* Gray 800 */
            border-radius: 1.5rem 1.5rem 1.5rem 0.5rem; /* Rounded corners, pointed bottom-left */
            max-width: 80%;
            word-wrap: break-word;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
        }
        /* Scrollbar styling for a cleaner look */
        .chat-container::-webkit-scrollbar {
            width: 6px;
        }
        .chat-container::-webkit-scrollbar-thumb {
            background-color: #d1d5db; /* Gray 300 */
            border-radius: 3px;
        }
    </style>
</head>
<body class="flex items-center justify-center min-h-screen p-4">

    <!-- Main Chat Interface -->
    <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg flex flex-col h-[90vh] md:h-[80vh] overflow-hidden">
        
        <!-- Header -->
        <header class="bg-indigo-700 p-4 rounded-t-xl shadow-md flex items-center justify-between">
            <h1 class="text-xl font-bold text-white">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 inline-block mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.69A9 9 0 0112 3c4.97 0 9 3.582 9 8z" />
                </svg>
                Smart Enquiry Assistant
            </h1>
        </header>

        <!-- Chat History Area -->
        <div id="chatHistory" class="chat-container flex-1 p-4 space-y-4">
            <!-- Welcome Message (Updated for XYZ College) -->
            <div class="flex justify-start">
                <div class="bot-message p-3 max-w-xs md:max-w-md">
                    <p class="font-semibold text-indigo-700">UniBot</p>
                    <p>Welcome! I am UniBot, the Smart Enquiry Assistant for **XYZ College**. Please note I am currently running as a test instance. I can assist you with queries on admissions, fees, courses, placements, events, sports, and hostel details. How can I help you today?</p>
                </div>
            </div>
        </div>

        <!-- Input and Control Area -->
        <div class="p-4 border-t border-gray-200">
            <!-- Escalation Notice (Updated with consistent email) -->
            <div id="escalationNotice" class="hidden mb-3 p-2 bg-yellow-100 border-l-4 border-yellow-500 text-yellow-800 rounded-lg text-sm transition-all duration-300">
                ⚠️ **Escalation Suggestion:** This query may require human review. Please email our administrative staff at <a href="mailto:contact@xyzcollege.edu" class="underline font-medium">contact@xyzcollege.edu</a> for a detailed response.
            </div>

            <div class="flex space-x-3">
                <input type="text" id="userInput" placeholder="Ask your question..."
                       class="flex-1 p-3 border border-gray-300 rounded-full focus:ring-2 focus:ring-indigo-500 focus:border-indigo-500 transition duration-150">
                <button id="sendButton" onclick="sendMessage()"
                        class="bg-indigo-600 text-white p-3 rounded-full hover:bg-indigo-700 transition duration-150 shadow-lg active:scale-95 disabled:bg-indigo-400">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M14 5l7 7m0 0l-7 7m7-7H3" />
                    </svg>
                </button>
            </div>
            <p id="loadingIndicator" class="text-center text-sm text-gray-500 mt-2 hidden">
                <span class="animate-pulse">Assistant is thinking...</span>
            </p>
        </div>

    </div>

    <script>
        // Configuration and Constants
        const MODEL_NAME = 'gemini-2.5-flash-preview-09-2025';
        const API_KEY = ""; // Canvas will automatically provide the API key
        const API_URL = `https://generativelanguage.googleapis.com/v1beta/models/${MODEL_NAME}:generateContent?key=${API_KEY}`;
        const chatHistoryDiv = document.getElementById('chatHistory');
        const userInput = document.getElementById('userInput');
        const sendButton = document.getElementById('sendButton');
        const loadingIndicator = document.getElementById('loadingIndicator');
        const escalationNotice = document.getElementById('escalationNotice');
        
        // Chat history to maintain context
        let chatHistory = [];
        
        // System instruction to define the chatbot's role (Updated for XYZ College personality and default facts)
        const systemInstruction = "You are UniBot, the helpful and professional Smart Enquiry Assistant for XYZ College. Your persona is that of a reliable institutional bridge: friendly, consistent, formal, and focused. Note: This is a test instance of the Smart Enquiry System. For institutional details, rely on the following default facts, and mention the college name (XYZ College) in your greetings and context.\n\n[DEFAULT FACTS: College Name: XYZ College | Address: 123 Innovation Drive, Tech City, State 560001 | Default Contact Email: contact@xyzcollege.edu]\n\nYou MUST restrict your answers ONLY to the following core university topics: admissions, fee structure, placement details, course information, event updates, sports, hostel, and general campus queries. If a question is outside these defined topics (e.g., philosophy, cooking, general knowledge, etc.), you must politely decline and reiterate that you are only programmed to assist with XYZ College-specific enquiries.\n\nUse Google Search grounding to find the most accurate and up-to-date information, but prioritize the default facts for college identity. If a query requires human review, respectfully guide the user to contact the administrative staff directly via the default contact email (contact@xyzcollege.edu).";

        // --- Utility Functions ---

        /**
         * Adds a message to the chat history UI.
         * @param {string} text - The message content.
         * @param {string} sender - 'user' or 'bot'.
         */
        function addMessageToUI(text, sender) {
            const messageWrapper = document.createElement('div');
            messageWrapper.className = `flex ${sender === 'user' ? 'justify-end' : 'justify-start'}`;
            
            const messageBubble = document.createElement('div');
            messageBubble.className = `${sender === 'user' ? 'user-message' : 'bot-message'} p-3 max-w-xs md:max-w-md transition-all duration-300 transform translate-y-2 opacity-0`;
            
            if (sender === 'bot') {
                const senderLabel = document.createElement('p');
                senderLabel.className = 'font-semibold text-indigo-700';
                senderLabel.textContent = 'UniBot';
                messageBubble.appendChild(senderLabel);

                // Add sources if available (simulated for MVP)
                const sourceText = document.createElement('div');
                sourceText.innerHTML = text;
                messageBubble.appendChild(sourceText);

            } else {
                messageBubble.textContent = text;
            }

            messageWrapper.appendChild(messageBubble);
            chatHistoryDiv.appendChild(messageWrapper);
            
            // Animate message
            setTimeout(() => {
                messageBubble.classList.remove('translate-y-2', 'opacity-0');
            }, 10);
            
            // Scroll to bottom
            chatHistoryDiv.scrollTop = chatHistoryDiv.scrollHeight;
        }

        /**
         * Converts markdown response text to HTML, specifically handling lists and bolding.
         * @param {string} markdownText - The text from the Gemini response.
         * @param {Array} sources - Array of citation objects.
         * @returns {string} HTML formatted text.
         */
        function formatGeminiResponse(markdownText, sources) {
            let htmlText = markdownText;

            // Simple Markdown conversions (bold, lists, newlines)
            htmlText = htmlText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>'); // Bold
            htmlText = htmlText.replace(/\n/g, '<br>'); // Newlines

            // Add Grounding Sources
            if (sources && sources.length > 0) {
                const uniqueSources = Array.from(new Set(sources.map(s => s.title))).slice(0, 3); // Max 3 unique titles
                const sourcesHtml = uniqueSources.map(title => 
                    `<span class="inline-block bg-gray-200 text-gray-700 text-xs font-medium px-2 py-0.5 rounded-full mr-1 mt-1">${title}</span>`
                ).join('');
                htmlText += `<div class="mt-3 pt-3 border-t border-gray-100 text-xs text-gray-500">
                    <p class="font-bold mb-1">Source Snippets:</p>
                    ${sourcesHtml}
                </div>`;
            }
            
            return htmlText;
        }

        /**
         * Checks if the query suggests the need for human escalation.
         * @param {string} query - The user's input.
         * @returns {boolean} True if escalation is likely needed.
         */
        function needsEscalationCue(query) {
            const lowPriorityWords = ["human", "admin", "administrator", "urgent", "escalate", "call me"];
            return lowPriorityWords.some(word => query.toLowerCase().includes(word));
        }

        // --- Main Logic ---

        async function callGeminiAPI(query) {
            try {
                // Prepare the history for the API payload
                // The history sent to the API is strictly the conversation turns
                const contents = chatHistory.map(item => ({
                    role: item.role === 'user' ? 'user' : 'model',
                    parts: [{ text: item.text }]
                }));

                // Add the current user query to the contents
                contents.push({ role: 'user', parts: [{ text: query }] });

                const payload = {
                    contents: contents,
                    
                    // CRITICAL: Enable Google Search grounding for factual, real-time responses
                    tools: [{ "google_search": {} }],

                    // CRITICAL: Define the model's persona and rules
                    systemInstruction: {
                        parts: [{ text: systemInstruction }]
                    }
                };
                
                let response;
                const maxRetries = 3;
                let delay = 1000;

                for (let i = 0; i < maxRetries; i++) {
                    try {
                        response = await fetch(API_URL, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(payload)
                        });
                        if (response.ok) break;
                    } catch (error) {
                        console.error(`Fetch attempt ${i + 1} failed:`, error);
                    }
                    if (i < maxRetries - 1) {
                        await new Promise(resolve => setTimeout(resolve, delay));
                        delay *= 2; // Exponential backoff
                    }
                }

                if (!response || !response.ok) {
                    throw new Error("API request failed after multiple retries.");
                }

                const result = await response.json();
                const candidate = result.candidates?.[0];

                if (candidate && candidate.content?.parts?.[0]?.text) {
                    const botText = candidate.content.parts[0].text;
                    let sources = [];
                    
                    // Extract Grounding Sources
                    const groundingMetadata = candidate.groundingMetadata;
                    if (groundingMetadata && groundingMetadata.groundingAttributions) {
                        sources = groundingMetadata.groundingAttributions
                            .map(attribution => ({
                                uri: attribution.web?.uri,
                                title: attribution.web?.title,
                            }))
                            .filter(source => source.uri && source.title);
                    }

                    // Add response to chat history
                    chatHistory.push({ role: 'bot', text: botText });
                    
                    // Format and display
                    const formattedResponse = formatGeminiResponse(botText, sources);
                    addMessageToUI(formattedResponse, 'bot');
                    
                } else {
                    addMessageToUI("I'm sorry, I couldn't generate a response. Please try rephrasing your question.", 'bot');
                }

            } catch (error) {
                console.error("Gemini API Error:", error);
                addMessageToUI("An error occurred while communicating with the server. Please try again.", 'bot');
            } finally {
                loadingIndicator.classList.add('hidden');
                sendButton.disabled = false;
                userInput.disabled = false;
                userInput.focus();
            }
        }

        function sendMessage() {
            const query = userInput.value.trim();
            if (!query) return;

            // 1. Display user message
            addMessageToUI(query, 'user');
            
            // 2. Add to chat history
            chatHistory.push({ role: 'user', text: query });
            
            // 3. Clear input and disable controls
            userInput.value = '';
            sendButton.disabled = true;
            userInput.disabled = true;
            loadingIndicator.classList.remove('hidden');
            
            // 4. Show/Hide escalation notice based on query
            if (needsEscalationCue(query)) {
                escalationNotice.classList.remove('hidden');
            } else {
                escalationNotice.classList.add('hidden');
            }

            // 5. Call the API
            callGeminiAPI(query);
        }

        // Event listeners for sending message
        window.onload = () => {
            userInput.addEventListener('keypress', (e) => {
                if (e.key === 'Enter') {
                    sendMessage();
                }
            });
            userInput.focus();
        };

    </script>
</body>
</html>